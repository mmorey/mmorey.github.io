<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Surf Dashboard</title>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        background-color: black;
        color: black;
        display: flex;
        flex-direction: column; /* Layout the body in a column */
      }

      #largeRectangle {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        aspect-ratio: 1.778; /* 16:9 */
        flex-grow: 1; /* Allow this div to grow as needed */
        border: 1px solid #333;
        position: relative;
        overflow: hidden;
      }

      #controls {
        display: flex;
        align-items: center;
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10; /* Ensures controls appear above the largeRectangle */
        background-color: gray;
        opacity: 0.5;
        padding: 10px;
      }

      #toggleRotation {
        margin-right: 10px; /* Space between button and label */
      }

      #videoOnlyLabel {
        display: flex;
        align-items: center;
      }

      #videoOnlyLabel input[type="checkbox"] {
        margin-right: 5px; /* Space between checkbox and label text */
      }

      #dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(705px, 1fr));
        grid-auto-rows: 399px;
        gap: 10px;
        width: 100%;
        box-sizing: border-box;
        padding: 10px;
        flex-grow: 1; /* Allow this div to grow as needed */
      }
      .rectangle {
        display: flex;
        justify-content: center; /* Horizontally center content */
        align-items: center; /* Vertically center content */
        width: 100%;
        height: 100%;
        border: 1px solid #333;
        position: relative;
        overflow: hidden;
        background-color: white;
      }

      .rectangle .content {
        max-width: 100%; /* Limit width to container's width */
        max-height: 100%; /* Limit height to container's height */
        object-fit: contain; /* Maintain aspect ratio without stretching */
      }

      .selector {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 2;
      }

      img,
      video {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  </head>
  <body>
    <div id="controls">
      <button id="toggleRotation">Start Rotation</button>
      <label id="videoOnlyLabel">
        <input type="checkbox" id="videoOnlyRotation" />
        Video Only
      </label>
    </div>
    <div id="largeRectangle"></div>

    <div id="dashboard"></div>
    <script>
      const timezoneString = getTimezoneString();
      const dateString = getDateString();
      const contentOptions = [
        {
          url: "https://cdip.ucsd.edu/recent/model_images/socal_now.png",
          name: "CDIP SoCal Now",
          hyperlink:
            "https://cdip.ucsd.edu/m/nowcast/?z=9&lat=33.5&lon=-118.8&wave_model=socal",
          type: "image",
        },
        {
          url: "http://cdip.ucsd.edu/recent/model_images/san_diego.png",
          name: "CDIP San Diego Now",
          type: "image",
        },
        {
          url: "https://cdip.ucsd.edu/recent/model_images/sd_hs.png",
          name: "CDIP SD Swell Height Prediction",
          type: "image",
        },
        {
          url: `http://cdip.ucsd.edu/themes/media/images/plots/9band_plot.gd?tz=${timezoneString}&units=english&spname=sp19101${dateString}`,
          name: "CDIP 191 9 Band Plot",
          hyperlink: "http://cdip.ucsd.edu/m/products/9band/?stn=191p1",
          type: "image",
        },
        {
          url: `http://cdip.ucsd.edu/themes/media/images/plots/9band_plot.gd?tz=${timezoneString}&units=english&spname=sp22001${dateString}`,
          name: "CDIP 220 9 Band Plot",
          hyperlink: "http://cdip.ucsd.edu/m/products/9band/?stn=220p1",
          type: "image",
        },
        {
          url: `https://www.tideschart.com/tide-charts/en/Pacific-Beach-Point-San-Diego-County-California-United-States-tide-chart-30038079-ft.png?date=${dateString}`,
          name: "PB Point Tides",
          hyperlink:
            "https://www.tideschart.com/United-States/California/San-Diego-County/Pacific-Beach-Point/",
          type: "image",
        },
        {
          url: "https://forecast.weather.gov/meteograms/Plotter.php?lat=32.7923&lon=-117.2519&wfo=SGX&zcode=CAZ043&gset=18&gdiff=3&unit=0&tinfo=PY8&ahour=0&pcmd=11011001000000000000000000000000000000000000000000000000000&lg=en&indu=1!1!1!&dd=&bw=&hrspan=48&pqpfhr=6&psnwhr=6",
          name: "PB Point Weather",
          hyperlink:
            "https://forecast.weather.gov/MapClick.php?w0=t&w1=td&w2=hi&w3=sfcwind&w3u=1&AheadHour=0&Submit=Submit&FcstType=graphical&textField1=32.7923&textField2=-117.2519&site=all&unit=0&dd=&bw=",
          type: "image",
        },
        {
          url: "http://www.stormsurfing.com/stormuser2/images/local/sd_srf.png",
          name: "Stormsurf SD Surf Forecast",
          hyperlink:
            "http://www.stormsurfing.com/cgi/display2.cgi?a=t19;b=sd_srf",
          type: "image",
        },
        {
          url: "https://b9.hdrelay.com/camera/7314af19-096b-4ab1-9cff-f5b2c33afa4f/relay/playlist.m3u",
          name: "Point Loma",
          type: "video",
        },
        {
          url: "https://edge06.nginx.hdontap.com/hosb4/ngrp:contour-lofts_downtown-sd_4k-ptz.stream_all/chunklist_w852105915_b16873891.m3u8",
          name: "SD Downtown-Airport-Bay",
          type: "video",
        },
        {
          url: "https://live.hdontap.com/hls/hosb1/hdontap_mission_beach.stream/playlist.m3u8",
          name: "Crystal Pier and South",
          type: "video",
        },
        {
          url: "https://cams.cdn-surfline.com/cdn-wc/wc-pacificbeach/playlist.m3u8",
          name: "Crystal Pier",
          type: "video",
        },
        {
          url: "https://cams.cdn-surfline.com/cdn-wc/wc-oldmanstourmaline/playlist.m3u8",
          name: "PB Point",
          type: "video",
        },
        {
          url: "https://cams.cdn-surfline.com/cdn-wc/wc-windansea/playlist.m3u8",
          name: "Windansea",
          type: "video",
        },
        {
          url: "https://cams.cdn-surfline.com/cdn-wc/wc-lajollashores/playlist.m3u8",
          name: "La Jolla Shores",
          type: "video",
        },
        {
          url: "https://cams.cdn-surfline.com/cdn-wc/wc-scripps/playlist.m3u8",
          name: "Scripps South Side",
          type: "video",
        },
        {
          url: "https://cams.cdn-surfline.com/cdn-wc/wc-scrippsnorth/playlist.m3u8",
          name: "Scripps North Side",
          type: "video",
        },
        {
          url: "https://cams.cdn-surfline.com/cdn-wc/wc-blacks/playlist.m3u8",
          name: "Blacks",
          type: "video",
        },
        {
          url: "https://cams.cdn-surfline.com/cdn-wc/wc-thepointsanonofre/playlist.m3u8",
          name: "San Onofre The Point",
          type: "video",
        },
        {
          url: "https://cams.cdn-surfline.com/cdn-wc/wc-lowers/playlist.m3u8",
          name: "Lower Trestles",
          type: "video",
        },
        {
          name: "Windy PB Point Embed",
          url: "Windy PB Point Embed",
          type: "html",
          embedCode: `<iframe width="707" height="396" src="https://embed.windy.com/embed2.html?lat=32.788&lon=-117.263&detailLat=32.652&detailLon=-117.297&width=650&height=450&zoom=10&level=surface&overlay=wind&product=ecmwf&menu=&message=true&marker=true&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=default&metricTemp=default&radarRange=-1" frameborder="0"></iframe>`,
        },
        {
          name: "NWS SGX Weather Story",
          url: "https://www.weather.gov/images/sgx/WxStory/WeatherStory1.png",
          hyperlink: "https://www.weather.gov/sgx/",
          type: "image",
        },
      ];

      // Return date string with format year, month, day ex: 20231222
      function getDateString() {
        const date = new Date();
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();

        return `${year}${month < 10 ? "0" : ""}${month}${
          day < 10 ? "0" : ""
        }${day}`;
      }

      // Return 3 letter timezon string, ex: PST
      function getTimezoneString() {
        const now = new Date();
        return now
          .toLocaleTimeString("en-us", { timeZoneName: "short" })
          .split(" ")[2];
      }

      function generateRectangles() {
        const dashboard = document.getElementById("dashboard");

        // Create a selector for the large rectangle
        const largeSelector = document.createElement("select");
        largeSelector.classList.add("selector");
        largeSelector.onchange = (event) =>
          loadContent(largeRectangle, event.target.value, "large");

        const defaultLargeOption = document.createElement("option");
        defaultLargeOption.textContent = "Select Content";
        defaultLargeOption.disabled = true;
        defaultLargeOption.selected = true;
        largeSelector.appendChild(defaultLargeOption);

        contentOptions.forEach((optionData) => {
          const option = document.createElement("option");
          option.value = optionData.url;
          option.textContent = optionData.name;
          largeSelector.appendChild(option);
        });
        // Load and apply saved selection from localStorage
        const largeSavedUrl = localStorage.getItem(`rectangle_large`);
        if (largeSavedUrl) {
          loadContent(largeRectangle, largeSavedUrl, "large");
          largeSelector.value = largeSavedUrl;
        }

        largeRectangle.appendChild(largeSelector);

        // Create 6 smaller rectangles with the same selection options
        for (let i = 0; i < 8; i++) {
          const rectangle = document.createElement("div");
          rectangle.classList.add("rectangle");
          const selector = document.createElement("select");
          selector.classList.add("selector");
          selector.onchange = (event) =>
            loadContent(rectangle, event.target.value, i);

          const defaultOption = document.createElement("option");
          defaultOption.textContent = "Select Content";
          defaultOption.disabled = true;
          defaultOption.selected = true;
          selector.appendChild(defaultOption);

          contentOptions.forEach((optionData) => {
            const option = document.createElement("option");
            option.value = optionData.url;
            option.textContent = optionData.name;
            selector.appendChild(option);
          });

          // Load and apply saved selection from localStorage
          const savedUrl = localStorage.getItem(`rectangle_${i}`);
          if (savedUrl) {
            loadContent(rectangle, savedUrl, i);
            selector.value = savedUrl;
          }

          rectangle.appendChild(selector);
          dashboard.appendChild(rectangle);
        }
      }

      function loadContent(rectangle, url, index) {
        // Clear existing content
        const existingContent = rectangle.querySelector(".content");
        if (existingContent) {
          rectangle.removeChild(existingContent);
        }

        // Find contentOptions entry for the given url
        const option = contentOptions.find((option) => option.url === url);

        if (option && option.type === "html") {
          const embedContainer = document.createElement("div");
          embedContainer.classList.add("content");
          embedContainer.innerHTML = option.embedCode;
          rectangle.appendChild(embedContainer);
        } else if (url.includes(".m3u8")) {
          // Create a video element for .m3u8
          const video = document.createElement("video");
          video.classList.add("content");
          video.controls = true;
          video.autoplay = true;
          rectangle.appendChild(video);

          // Check if HLS is supported natively or by hls.js
          if (video.canPlayType("application/vnd.apple.mpegurl")) {
            // For browsers that can play HLS without hls.js
            video.src = url;
          } else if (Hls.isSupported()) {
            const hls = new Hls();
            hls.loadSource(url);
            hls.attachMedia(video);
          } else {
            console.error("HLS format not supported");
          }
        } else {
          // Create an image element for standard images
          const img = document.createElement("img");
          img.src = url;
          img.classList.add("content");
          img.alt = "Loaded content";
          rectangle.appendChild(img);
        }

        // Add hyperlink if available
        if (option && option.hyperlink) {
          const hyperlink = document.createElement("a");
          hyperlink.href = option.hyperlink;
          hyperlink.target = "_blank";
          hyperlink.textContent = "🔗";
          hyperlink.style.position = "absolute";
          hyperlink.style.bottom = "10px";
          hyperlink.style.right = "10px";
          hyperlink.style.color = "grey";
          hyperlink.style.zIndex = 2;
          rectangle.appendChild(hyperlink);
        }

        // Save selection to localStorage
        localStorage.setItem(`rectangle_${index}`, url);
      }

      window.onload = generateRectangles;
    </script>
    <script>
      var rotateInterval;
      var isRotating = false;
      var videoOnly = false;

      function toggleRotation() {
        isRotating = !isRotating;
        document.getElementById("toggleRotation").textContent = isRotating
          ? "Stop Rotation"
          : "Start Rotation";

        if (isRotating) {
          startRotation();
        } else {
          stopRotation();
        }
      }

      function startRotation() {
        let index = 0;

        // Find the first video option if videoOnly is true
        if (videoOnly) {
          index = contentOptions.findIndex((option) =>
            option.url.includes(".m3u8")
          );
          if (index === -1) {
            console.error("No video content found");
            return; // Stop if no video content is available
          }
        }

        rotateContent(index);

        rotateInterval = setInterval(function () {
          do {
            index = (index + 1) % contentOptions.length;
          } while (videoOnly && !contentOptions[index].url.includes(".m3u8"));

          rotateContent(index);
        }, 20000); // Rotate every 20 seconds
      }

      function stopRotation() {
        clearInterval(rotateInterval);
      }

      function rotateContent(index) {
        const option = contentOptions[index];
        if (option) {
          loadContent(largeRectangle, option.url, "large");
          document.querySelector("#largeRectangle .selector").value =
            option.url;
        }
      }

      document
        .getElementById("toggleRotation")
        .addEventListener("click", toggleRotation);
      document
        .getElementById("videoOnlyRotation")
        .addEventListener("change", function () {
          videoOnly = this.checked;
          if (isRotating) {
            stopRotation();
            startRotation();
          }
        });

      // Rest of your JavaScript functions...
    </script>
  </body>
</html>
